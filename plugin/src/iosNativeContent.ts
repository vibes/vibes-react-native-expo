// Anchors RegExp
export const MATCH_APP_DELEGATE_IMPORTS_OBJCPP = /#import "AppDelegate\.h"/;
export const MATCH_APP_DELEGATE_IMPORTS_SWIFT = /@UIApplicationMain/;
export const MATCH_FINISH_LAUNCHING_METHOD_OBJCPP =
  /-\s*\(BOOL\)\s*application:\s*\(UIApplication\s*\*\s*\)\s*\w+\s+didFinishLaunchingWithOptions:/g;
export const MATCH_FINISH_LAUNCHING_METHOD_SWIFT =
  /\b(return\s+)?super\.application\(\w+?, didFinishLaunchingWithOptions: \w+?\)/g;

// Device token registration patterns - more flexible to catch existing methods
export const MATCH_DEVICE_TOKEN_METHOD_OBJCPP =
  /-\s*\(void\)\s*application:\s*\(UIApplication\s*\*\s*\)\s*\w+\s+didRegisterForRemoteNotificationsWithDeviceToken:\s*\(NSData\s*\*\s*\)\s*\w+/g;
export const MATCH_DEVICE_TOKEN_METHOD_SWIFT =
  /\bfunc\s+application\(\s*_\s+application:\s*UIApplication,\s*didRegisterForRemoteNotificationsWithDeviceToken\s+deviceToken:\s*Data\s*\)/g;



// Device token registration code
export const REGISTER_DEVICE_TOKEN_OBJCPP = `  [VibesBridge registerDeviceToken:deviceToken];`;
export const REGISTER_DEVICE_TOKEN_SWIFT = `    Vibes.shared.setPushToken(from: deviceToken)`;


export const getBridgeHeaderObjC = (projectName: string) => `//
//  VibesBridge.h
//  ${projectName}
//
//  Generated by expo-vibes-sdk plugin
//

#import <Foundation/Foundation.h>

@interface VibesBridge : NSObject

+ (void)configureVibes;
+ (void)registerDeviceToken:(NSData *)deviceToken;

@end
`;

export const getBridgeImplementationObjC = (
  projectName: string,
  appId: string,
  appUrl?: string,
): string => {
  const apiUrlValue = appUrl ? `@"${appUrl}"` : "NULL";
  const trackingApiUrlValue = appUrl ? `@"${appUrl}"` : "NULL";

  return `//
//  VibesBridge.m
//  ${projectName}
//
//  Generated by expo-vibes-sdk plugin
//

#import <Foundation/Foundation.h>
#import "VibesBridge.h"
@import VibesPush;

@implementation VibesBridge

+ (void)configureVibes
{
  VibesConfiguration *vibesConfig = [[VibesConfiguration alloc] initWithAdvertisingId:NULL
                                                                                  apiUrl:${apiUrlValue}
                                                                         trackingApiUrl:${trackingApiUrlValue}
                                                                                  logger:NULL
                                                                             storageType:VibesStorageEnumUSERDEFAULTS
                                                                       trackedEventTypes:[@[] mutableCopy]];
  [Vibes configureWithAppId:@"${appId}"
              configuration:vibesConfig];
}

+ (void)registerDeviceToken:(NSData *)deviceToken
{
  NSLog(@"Device token received by VibesBridge: %@", deviceToken);
  
  // Convert NSData to hex string
  NSMutableString *token = [NSMutableString string];
  const char *bytes = [deviceToken bytes];
  for (NSUInteger i = 0; i < [deviceToken length]; i++) {
    [token appendFormat:@"%02.2hhx", bytes[i]];
  }
  
  // Set device token in Vibes SDK
  [Vibes.shared setPushTokenFromData:deviceToken];
  NSLog(@"ðŸ”‘ [PUSH_TOKEN] Device token set in Vibes SDK");
  
  // Store token in UserDefaults so ExpoVibesSDKModule can retrieve it
  [[NSUserDefaults standardUserDefaults] setObject:token forKey:@"ExpoVibesSDK_LastDeviceToken"];
  NSLog(@"ðŸ”‘ [PUSH_TOKEN] Device token stored in UserDefaults: %@", token);
  
  // NOTE: registerPush() should be called manually by the app, not automatically
  // This follows the official Vibes SDK examples
}

@end
`;
};

// Objcpp App Delegate Vibes Bridge

export const IMPORT_VIBES_BRIDGE_OBJCPP = `#import "VibesBridge.h"`;
export const CONFIGURE_VIBES_BRIDGE_OBJCPP = `  [VibesBridge configureVibes];`;

// Swift App Delegate Vibes Config
export const IMPORT_VIBES_PACKAGE_SWIFT = `import VibesPush`;

export const getOptionalConfigLinesSwift = (appId: string, appUrl: string) => [
  `    let configuration = VibesConfiguration(`,
  `      advertisingId: nil,`,
  `      apiUrl: "${appUrl}",`,
  `      logger: nil,`,
  `      storageType: .USERDEFAULTS,`,
  `      trackedEventTypes: [TrackedEventType.launch, TrackedEventType.clickthru] as NSArray`,
  `    )`,
  `    Vibes.configure(appId: "${appId}", configuration: configuration)`,
];

export const getConfigLineSwift = (appId: string) =>
  `    Vibes.configure(appId: "${appId}")`;
